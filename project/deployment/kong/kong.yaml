_format_version: "3.0"

services:
  - name: file-service
    url: http://file-service:8082
    routes:
      - name: file-route
        paths:
          - /api/files
        strip_path: false
        plugins:
          - name: openid-connect
            service: file-service
            config:
              header_name:
                - Authorization
              key_claim_name: iss
              claims_to_verify:
                - exp
              claims_to_header:
                - sub: X-User-Id
                - email: X-User-Email
                - preferred_username: X-User-Name
  - name: profile-service
    url: http://profile-service:8083
    routes:
      - name: profile-route
        paths:
          - /api/profiles
        strip_path: false
        plugins:
          - name: jwt
            config:
              header_name:
                - Authorization
              claims_to_verify:
                - exp
              claims_to_header:
                - sub: X-User-Id
                - email: X-User-Email
                - preferred_username: X-User-Name
  - name: post-service
    url: http://post-service:8084
    routes:
      - name: post-route
        paths:
          - /api/posts
        strip_path: false
        plugins:
          - name: jwt
            config:
              header_name:
                - Authorization
              claims_to_verify:
                - exp
              claims_to_header:
                - sub: X-User-Id
                - email: X-User-Email
                - preferred_username: X-User-Name

consumers:
  - username: keycloak_issuer
    jwt_secrets:
      - key: "http://localhost:8080/realms/master"
        algorithm: RS256
        rsa_public_key: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu...
        secret: "something"

plugins:
  - name: rate-limiting
    config:
      second: 10
      policy: local
      error_code: 429
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type